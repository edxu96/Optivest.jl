---
title: "Production Investment and Economic Dispatch in Sustainble Energy System"
output: html_notebook
author: Edward J. Xu (<edxu96@outlook.com>)
date: "`r Sys.Date()`"
---

```{r, echo=FALSE}
rm(list = ls())
setwd("~/GitHub/Optivest.jl/Power-System/PIED")

knitr::opts_chunk$set(
  collapse = FALSE,
  echo = FALSE,
  comment = "#>",
  fig.align = "center",
  fig.asp = 9/16,
  fig.width = 5,
  warning = FALSE,
  message = FALSE
)
```

```{r, message=FALSE}
library(tidyverse)
library(magrittr)
library(ggplot2)
library(tidyr)
library(kableExtra)
library(knitr)
```

```{r, message=FALSE}
ti_dk1 <- 
  read_csv2("./data/Electricity-Dispatch_DK1.csv") %>%
  mutate(OffshoreWindPower = as.numeric(OffshoreWindPower)) %>%
  mutate(TotalLoad = TotalLoad / 100) %>%
  mutate(OnshoreWindPower = OnshoreWindPower / 100)
```

```{r}
get_result_dispatch <- function(str_file, z){
  ti <-
    read_csv(str_file, col_names = c("gt", "bio")) %>%
    mutate(index = row_number()) %>%
    bind_cols(ti_dk1[1:168, 4]) %>%
    bind_cols(ti_dk1[1:168, 5:6]) %>%
    mutate(wind_total = (OnshoreWindPower + OffshoreWindPower) * z) %>%
    mutate(demand = TotalLoad) %>%
    mutate(wind_net = demand - gt - bio) %>%
    select(index, demand, wind_total, wind_net, gt, bio)

  return(ti)
}

plot_dispatch <- function(ti, y_gt, y_bio){
  ti %>%
    gather(-index, key = "whi", value = "power") %>%
    ggplot() + 
      geom_line(mapping = aes(x = index, y = power, color = whi)) +
      geom_hline(yintercept = y_gt, color = "grey", linetype = "dashed") +
      geom_hline(yintercept = y_gt * 0.23, color = "grey", linetype = "dashed") +
      geom_hline(yintercept = y_bio, color = "grey", linetype = "dashed") +
      geom_hline(yintercept = y_bio * 0.5, color = "grey", linetype = "dashed") +
      labs(
        title = "Demand, Wind Power Output, Dispatch of GT and Bio",
        x = "Time Index", y = "Power (MW)"
        )
}

plot_dispatch_stack <- function(ti){
  ti %>%
    select(index, bio, gt, wind_net) %>%
    gather(-index, key = "whi", value = "power") %>%
    ggplot() +
      geom_area(mapping = aes(x = index, y = power, fill = whi)) +
      labs(
        title = "Stacked Area Plot of Wind Power Output, Dispatch of GT and Bio",
        x = "Time Index", y = "Power (MW)"
        )
}
```


## 1, Results of the Model without Storage Devices

```{r, message=FALSE}
ti <- 
  get_result_dispatch("./results/c_fix_wind-1000000/mat_x_result_1.csv", 0.7991)

ti %>% 
  plot_dispatch(568.61, 2229.65)
```

Difference between total and net wind power output is the curtailed wind power.

```{r}
ti %>%
  plot_dispatch_stack()
```

## 2, Results of the Model with BEVs

```{r}
ti_2 <- 
  get_result_dispatch("./results/c_fix_wind-1000000/mat_x_result_2.csv", 0.6374)

ti_2 %>% 
  plot_dispatch(181.80, 2473.48)
```

Note that negative power output from wind and storage happens around 25.

```{r}
ti_2 %>%
  plot_dispatch_stack()
```

